<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Research Peptide Catalog | Pepstar Peptides</title>
    <meta name="description" content="Browse our complete catalog of premium research peptides. 99%+ purity, third-party tested.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #0B4B8E; --primary-dark: #083a6e; --accent: #FF7D24; --accent-glow: rgba(255,125,36,0.3); --bg-light: #f8f9fb; --bg-white: #ffffff; --text-primary: #1a2b32; --text-secondary: #5a6d75; --text-muted: #8a9da5; --border: #e2e8eb; --border-light: #f0f4f5; --shadow-sm: 0 2px 8px rgba(11,75,142,0.06); --shadow-md: 0 8px 24px rgba(11,75,142,0.1); --shadow-lg: 0 16px 48px rgba(11,75,142,0.12); --radius-sm: 8px; --radius-md: 12px; --radius-lg: 20px; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-light); color: var(--text-primary); line-height: 1.6; }
        h1, h2, h3, h4 { font-family: 'Space Grotesk', sans-serif; font-weight: 600; line-height: 1.2; }
        a { text-decoration: none; color: inherit; }
        header { position: fixed; top: 0; left: 0; right: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); z-index: 1000; border-bottom: 1px solid var(--border-light); }
        .header-inner { max-width: 1400px; margin: 0 auto; padding: 0 40px; height: 72px; display: flex; align-items: center; justify-content: space-between; }
        .logo { display: flex; align-items: center; }
        .logo-img { height: 60px; width: auto; }
        nav { display: flex; align-items: center; gap: 32px; }
        nav a { font-weight: 500; color: var(--text-secondary); transition: color 0.2s; font-size: 0.95rem; }
        nav a:hover, nav a.active { color: var(--primary); }
        .header-actions { display: flex; align-items: center; gap: 12px; }
        .header-search { position: relative; }
        .header-search input { width: 200px; padding: 10px 14px 10px 38px; border: 1px solid var(--border); border-radius: var(--radius-sm); font-family: inherit; font-size: 0.9rem; transition: all 0.2s; }
        .header-search input:focus { outline: none; border-color: var(--primary); width: 260px; }
        .header-search svg { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; stroke: var(--text-muted); }
        .cart-btn { position: relative; width: 44px; height: 44px; background: var(--bg-light); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; }
        .cart-btn:hover { background: var(--border); }
        .cart-btn svg { width: 20px; height: 20px; stroke: var(--text-primary); }
        .cart-count { position: absolute; top: -4px; right: -4px; background: var(--accent); color: white; font-size: 0.7rem; font-weight: 700; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .btn-primary { background: var(--primary); color: white; padding: 10px 20px; border-radius: var(--radius-sm); font-weight: 600; font-size: 0.9rem; }
        .btn-primary:hover { background: var(--primary-dark); }
        .mobile-nav-toggle { display: none; background: none; border: none; cursor: pointer; padding: 8px; }
        .mobile-nav-toggle svg { width: 24px; height: 24px; stroke: var(--text-primary); }
        .page-content { padding: 112px 40px 60px; max-width: 1400px; margin: 0 auto; }
        .page-header { margin-bottom: 32px; }
        .page-header h1 { font-size: 2.5rem; margin-bottom: 8px; }
        .page-header p { color: var(--text-secondary); font-size: 1.1rem; }
        .catalog-layout { display: grid; grid-template-columns: 280px 1fr; gap: 40px; }
        .sidebar { position: sticky; top: 112px; height: fit-content; }
        .filter-section { background: white; border-radius: var(--radius-md); padding: 24px; margin-bottom: 20px; box-shadow: var(--shadow-sm); }
        .filter-section h3 { font-size: 0.95rem; margin-bottom: 16px; color: var(--text-primary); }
        .filter-checkbox { display: flex; align-items: center; gap: 10px; padding: 8px 0; cursor: pointer; }
        .filter-checkbox input { width: 18px; height: 18px; accent-color: var(--primary); }
        .filter-checkbox span { font-size: 0.9rem; color: var(--text-secondary); }
        .price-inputs { display: flex; gap: 12px; }
        .price-inputs input { flex: 1; padding: 10px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); font-family: inherit; font-size: 0.9rem; }
        .price-inputs input:focus { outline: none; border-color: var(--primary); }
        .search-box { position: relative; margin-bottom: 16px; }
        .search-box input { width: 100%; padding: 12px 14px 12px 40px; border: 1px solid var(--border); border-radius: var(--radius-sm); font-family: inherit; font-size: 0.9rem; }
        .search-box input:focus { outline: none; border-color: var(--primary); }
        .search-box svg { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; stroke: var(--text-muted); }
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
        .toolbar-left { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }
        .results-count { font-size: 0.9rem; color: var(--text-secondary); }
        .active-filters { display: flex; gap: 8px; flex-wrap: wrap; }
        .filter-tag { display: inline-flex; align-items: center; gap: 6px; background: var(--primary); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; }
        .filter-tag button { background: none; border: none; cursor: pointer; padding: 0; display: flex; }
        .filter-tag svg { width: 14px; height: 14px; stroke: white; }
        .sort-select select { padding: 10px 14px; border: 1px solid var(--border); border-radius: var(--radius-sm); font-family: inherit; font-size: 0.9rem; background: white; cursor: pointer; }
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 24px; }
        .product-card { background: white; border-radius: var(--radius-md); overflow: hidden; box-shadow: var(--shadow-sm); cursor: pointer; transition: all 0.3s; }
        .product-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); }
        .product-image { aspect-ratio: 1; background: linear-gradient(135deg, var(--bg-light) 0%, #e8f4fc 100%); display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        .product-image img { width: 100%; height: 100%; object-fit: cover; object-position: center; }
        .product-placeholder svg { width: 48px; height: 48px; stroke: var(--primary); opacity: 0.3; fill: none; stroke-width: 1.5; }
        .product-badge { position: absolute; top: 12px; left: 12px; background: var(--accent); color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .stock-badge { padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; margin: 8px 0; text-align: center; }
        .stock-badge.out-of-stock { background: #fff5f5; color: #e53e3e; border: 1px solid #fed7d7; }
        .stock-badge.low-stock { background: #fffbeb; color: #d69e2e; border: 1px solid #fef3c7; }
        .stock-badge.in-stock { background: #f0fff4; color: #38a169; border: 1px solid #c6f6d5; }
        .product-card.out-of-stock { opacity: 0.7; }
        .product-card.out-of-stock .product-image { filter: grayscale(50%); }
        .spec-item.stock-spec { grid-column: 1 / -1; margin-top: 8px; }
        .modal-add-btn:disabled { background: #a0aec0; cursor: not-allowed; }
        .product-info { padding: 20px; }
        .product-category { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--accent); font-weight: 600; margin-bottom: 6px; }
        .product-name { font-size: 1.1rem; margin-bottom: 8px; }
        .product-meta { display: flex; gap: 12px; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 12px; }
        .product-price { font-size: 1.25rem; font-weight: 700; color: var(--primary); margin-bottom: 8px; }
        .product-price.hidden-price { font-size: 0.9rem; color: var(--text-muted); font-weight: 500; }
        .product-sizes { display: flex; gap: 6px; flex-wrap: wrap; }
        .size-tag { background: var(--bg-light); padding: 4px 10px; border-radius: 4px; font-size: 0.75rem; color: var(--text-secondary); }
        .empty-state { text-align: center; padding: 60px 20px; }
        .empty-state svg { width: 64px; height: 64px; stroke: var(--text-muted); margin-bottom: 16px; }
        .empty-state h3 { margin-bottom: 8px; }
        .empty-state p { color: var(--text-secondary); margin-bottom: 20px; }
        .empty-state button { background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: var(--radius-sm); font-family: inherit; font-weight: 600; cursor: pointer; }
        .hidden { display: none !important; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background: white; border-radius: var(--radius-lg); max-width: 900px; width: 100%; max-height: 90vh; overflow: hidden; display: grid; grid-template-columns: 1fr 1fr; }
        .modal-image { background: linear-gradient(135deg, var(--bg-light) 0%, #e8f4fc 100%); display: flex; align-items: center; justify-content: center; min-height: 400px; overflow: hidden; position: relative; }
        .modal-image img { width: 100%; height: 100%; object-fit: cover; object-position: center; position: absolute; top: 0; left: 0; }
        .modal-image svg { width: 80px; height: 80px; stroke: var(--primary); opacity: 0.3; fill: none; stroke-width: 1.5; }
        .modal-body { padding: 32px; display: flex; flex-direction: column; max-height: 90vh; overflow-y: auto; }
        .modal-close { position: absolute; top: 16px; right: 16px; background: white; border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-sm); }
        .modal-close svg { width: 20px; height: 20px; stroke: var(--text-primary); }
        .modal-category { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--accent); font-weight: 600; margin-bottom: 8px; }
        .modal-title { font-size: 1.75rem; margin-bottom: 16px; }
        .modal-specs { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; padding: 16px; background: var(--bg-light); border-radius: var(--radius-sm); }
        .spec-item label { display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 2px; }
        .spec-item span { font-weight: 600; font-size: 0.9rem; }
        .modal-size-select { margin-bottom: 16px; }
        .modal-size-select label { display: block; font-size: 0.9rem; font-weight: 500; margin-bottom: 8px; }
        .modal-size-select label span { color: var(--accent); }
        .modal-size-select select { width: 100%; padding: 14px; border: 1px solid var(--border); border-radius: var(--radius-sm); font-family: inherit; font-size: 1rem; cursor: pointer; }
        .modal-size-select select:focus { outline: none; border-color: var(--primary); }
        .modal-size-select select.error { border-color: #e53935; }
        .size-error { color: #e53935; font-size: 0.85rem; margin-top: 6px; display: none; }
        .size-error.show { display: block; }
        .modal-add-btn { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: var(--radius-sm); font-family: inherit; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background 0.2s; margin-bottom: 20px; }
        .modal-add-btn:hover { background: var(--primary-dark); }
        .modal-description-section { border-top: 1px solid var(--border); padding-top: 20px; }
        .modal-description-title { font-size: 0.9rem; font-weight: 600; color: var(--text-primary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.05em; }
        .modal-description { max-height: 200px; overflow-y: auto; font-size: 0.9rem; color: var(--text-secondary); line-height: 1.7; padding-right: 8px; }
        .modal-description::-webkit-scrollbar { width: 6px; }
        .modal-description::-webkit-scrollbar-track { background: var(--bg-light); border-radius: 3px; }
        .modal-description::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        .modal-description::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
        .toast { position: fixed; bottom: 24px; right: 24px; background: var(--text-primary); color: white; padding: 16px 24px; border-radius: var(--radius-sm); box-shadow: var(--shadow-lg); transform: translateY(100px); opacity: 0; transition: all 0.3s; z-index: 3000; }
        .toast.show { transform: translateY(0); opacity: 1; }
        footer { background: var(--text-primary); color: white; padding: 60px 40px 30px; margin-top: 80px; }
        .footer-content { max-width: 1400px; margin: 0 auto; display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 40px; margin-bottom: 40px; }
        .footer-brand p { color: rgba(255,255,255,0.7); margin-top: 16px; font-size: 0.9rem; }
        .footer-brand .logo-img { height: 50px; filter: brightness(0) invert(1); }
        .footer-links h4 { font-size: 0.9rem; margin-bottom: 16px; }
        .footer-links a { display: block; color: rgba(255,255,255,0.7); font-size: 0.9rem; padding: 6px 0; transition: color 0.2s; }
        .footer-links a:hover { color: white; }
        .footer-bottom { text-align: center; padding-top: 30px; border-top: 1px solid rgba(255,255,255,0.1); color: rgba(255,255,255,0.5); font-size: 0.85rem; }
        @media (max-width: 1024px) { .catalog-layout { grid-template-columns: 1fr; } .sidebar { position: static; display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; } .filter-section { margin-bottom: 0; } }
        @media (max-width: 768px) { .header-inner { padding: 0 20px; } nav { display: none; } .mobile-nav-toggle { display: block; } .page-content { padding: 100px 20px 40px; } .modal-content { grid-template-columns: 1fr; max-height: 95vh; } .modal-image { min-height: 200px; } .footer-content { grid-template-columns: 1fr 1fr; } .header-search { display: none; } }
            
        }

    
        /* Mobile Menu Styles */
        .hamburger {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 5px;
            width: 44px;
            height: 44px;
            background: var(--bg-light);
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            padding: 10px;
            z-index: 1001;
        }
        .hamburger span {
            display: block;
            width: 22px;
            height: 2px;
            background: var(--text-primary);
            transition: all 0.3s ease;
        }
        .hamburger.active span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }
        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }
        .hamburger.active span:nth-child(3) {
            transform: rotate(-45deg) translate(5px, -5px);
        }
        .mobile-nav {
            display: none;
            position: fixed;
            top: 72px;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-white);
            z-index: 998;
            padding: 20px;
            flex-direction: column;
            overflow-y: auto;
        }
        .mobile-nav.active {
            display: flex;
        }
        .mobile-nav a {
            display: block;
            padding: 16px 20px;
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-light);
        }
        .mobile-nav a:hover {
            background: var(--bg-light);
        }
        .mobile-nav .btn-primary {
            margin-top: 20px;
            text-align: center;
        }
        @media (max-width: 768px) {
            .hamburger { display: flex !important; }
            nav { display: none !important; }
            .header-actions > .btn-primary { display: none !important; }
            .mobile-nav-toggle { display: none !important; }
        }

    </style>
</head>
<body>
    <header>
        <div class="header-inner">
            <a href="index.html" class="logo"><img src="logo.png" alt="Pepstar Peptides" class="logo-img"></a>
            <nav><a href="catalog.html" class="active">Catalog</a><a href="about.html">About</a><a href="faq.html">FAQ</a><a href="contact.html">Contact</a></nav>
            <div class="header-actions">
                <div class="header-search"><svg viewBox="0 0 24 24" fill="none" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" id="headerSearchInput" placeholder="Search peptides..."></div>
                <a href="cart.html" class="cart-btn"><svg viewBox="0 0 24 24" fill="none" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg><span class="cart-count" id="cartCount">0</span></a>
                <a href="login.html" class="btn-primary">Login</a><button class="hamburger" id="hamburger" onclick="toggleMobileNav()"><span></span><span></span><span></span></button></div></div></header>
    <!-- Mobile Navigation -->
    <div class="mobile-nav" id="mobileNav">
        <a href="index.html">Home</a>
        <a href="catalog.html">Catalog</a>
        <a href="about.html">About</a>
        <a href="faq.html">FAQ</a>
        <a href="contact.html">Contact</a>
        <a href="cart.html">Cart</a>
        <a href="login.html" class="btn-primary">Member Login</a>
    </div>

    <main class="page-content">
        <div class="page-header"><h1>Research Peptide Catalog</h1><p>Premium research compounds for qualified researchers</p></div>
        <div class="catalog-layout">
            <aside class="sidebar">
                <div class="filter-section"><h3>Search</h3><div class="search-box"><svg viewBox="0 0 24 24" fill="none" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" id="searchInput" placeholder="Search peptides..."></div></div>
                <div class="filter-section"><h3>Categories</h3><div id="categoryFilters"></div></div>
                <div class="filter-section members-only"><h3>Price Range</h3><div class="price-inputs"><input type="number" id="priceMin" placeholder="Min"><input type="number" id="priceMax" placeholder="Max"></div></div>
            </aside>
            <div class="main-content">
                <div class="toolbar">
                    <div class="toolbar-left"><span class="results-count" id="resultsCount">0 products</span><div class="active-filters" id="activeFilters"></div></div>
                    <div class="sort-select"><select id="sortSelect"><option value="name-asc">Name (A-Z)</option><option value="name-desc">Name (Z-A)</option><option value="price-asc">Price (Low-High)</option><option value="price-desc">Price (High-Low)</option></select></div>
                </div>
                <div class="products-grid" id="productsGrid"></div>
                <div class="empty-state hidden" id="emptyState"><svg viewBox="0 0 24 24" fill="none" stroke-width="1.5"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><h3>No products found</h3><p>Try adjusting your filters or search terms</p><button onclick="resetFilters()">Reset Filters</button></div>
            </div>
        </div>
    </main>

    <div class="modal-overlay" id="productModal">
        <div class="modal-content">
            <div class="modal-image"><img id="modalImage" src="" alt="" onerror="this.style.display='none';this.nextElementSibling.style.display='block';"><svg viewBox="0 0 24 24" style="display:none;"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg></div>
            <div class="modal-body">
                <button class="modal-close" onclick="closeModal()"><svg viewBox="0 0 24 24" fill="none" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
                <div class="modal-category" id="modalCategory"></div>
                <h2 class="modal-title" id="modalTitle"></h2>
                <div class="modal-specs" id="modalSpecs"></div>
                <div class="modal-size-select"><label>Select Size <span>*</span></label><select id="modalSizeSelect"></select><div class="size-error" id="sizeError">Please select a size</div></div>
                <button class="modal-add-btn" onclick="addModalToCart()">Add to Cart</button>
                <div class="modal-description-section">
                    <div class="modal-description-title">Research Overview</div>
                    <div class="modal-description" id="modalDescription"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"><span id="toastMessage"></span></div>

    <footer><div class="footer-content">
        <div class="footer-brand"><a href="index.html" class="logo"><img src="logo.png" alt="Pepstar Peptides" class="logo-img"></a><p>Premium research peptides for qualified researchers.</p></div>
        <div class="footer-links"><h4>Products</h4><a href="catalog.html">Full Catalog</a><a href="catalog.html?category=Tissue%20Repair">Tissue Repair</a><a href="catalog.html?category=GH%20Secretagogues">GH Secretagogues</a></div>
        <div class="footer-links"><h4>Company</h4><a href="about.html">About Us</a><a href="faq.html">FAQ</a><a href="contact.html">Contact</a></div>
        <div class="footer-links"><h4>Account</h4><a href="login.html">Member Login</a><a href="register.html">Apply for Account</a><a href="cart.html">View Cart</a></div>
    </div><div class="footer-bottom">&copy; 2025 Pepstar Peptides. For research purposes only.</div></footer>

    <script>

        // Mobile Navigation Toggle
        function toggleMobileNav() {
            const hamburger = document.getElementById('hamburger');
            const mobileNav = document.getElementById('mobileNav');
            hamburger.classList.toggle('active');
            mobileNav.classList.toggle('active');
            document.body.style.overflow = mobileNav.classList.contains('active') ? 'hidden' : '';
        }

        // Trello Inventory Configuration
        const TRELLO_CONFIG = {
            apiKey: '3ea0ef2b85773186d7ae30322ae1782d',
            token: 'ATTAde902321af1ec6600e16a0587516fb0b68cff7d5ce58997aa165fc08ba35568217827FB6',
            boardId: 'rWV4oPQr',
            inventoryListId: '697d87ef6d084cafcbaf70f3'
        };
        
        let products = [];
        let inventoryData = {};
        let productsLoaded = false;

        // Load products from Trello
        async function loadProductsFromTrello() {
            try {
                document.getElementById('productsGrid').innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:60px;color:#5a6d75;">Loading products...</div>';
                
                const cardsResponse = await fetch(
                    `https://api.trello.com/1/lists/${TRELLO_CONFIG.inventoryListId}/cards?key=${TRELLO_CONFIG.apiKey}&token=${TRELLO_CONFIG.token}`
                );
                const cards = await cardsResponse.json();
                
                // Parse each card into a product
                products = cards.map(card => {
                    const desc = card.desc;
                    
                    // Parse all fields from card description
                    const getField = (field) => {
                        const match = desc.match(new RegExp(`\\*\\*${field}:\\*\\*\\s*(.+?)(?=\\n|$)`));
                        return match ? match[1].trim() : '';
                    };
                    
                    const productName = getField('Product') || card.name;
                    const quantity = parseInt(getField('Quantity')) || 0;
                    const category = getField('Category') || 'Research Peptides';
                    const purity = getField('Purity') || '99%+';
                    const form = getField('Form') || 'Lyophilized Powder';
                    const sizesStr = getField('Sizes');
                    const pricesStr = getField('Prices');
                    const formula = getField('Formula') || 'N/A';
                    const weight = getField('Weight') || 'N/A';
                    const badge = getField('Badge') || '';
                    const descriptionRaw = getField('Description') || 'Premium research peptide for qualified researchers.';
                    
                    // Parse sizes array
                    let sizes = ['10mg'];
                    if (sizesStr) {
                        sizes = sizesStr.split(',').map(s => s.trim()).filter(s => s);
                    }
                    
                    // Parse prices object
                    let prices = {};
                    if (pricesStr) {
                        try {
                            prices = JSON.parse(pricesStr);
                        } catch (e) {
                            sizes.forEach(s => prices[s] = 50);
                        }
                    } else {
                        sizes.forEach(s => prices[s] = 50);
                    }
                    
                    // Store inventory
                    inventoryData[card.name] = quantity;
                    
                    return {
                        id: card.name,
                        image: `images/${card.name}.png`,
                        name: productName,
                        category: category,
                        description: descriptionRaw.replace(/\\n/g, '\n'),
                        sizes: sizes,
                        prices: prices,
                        purity: purity,
                        form: form,
                        specs: { formula: formula, weight: weight },
                        badge: badge || undefined,
                        popularity: 5
                    };
                });
                
                productsLoaded = true;
                console.log('Products loaded from Trello:', products.length);
                
                updateCategories();
                renderCategoryFilters();
                applyFilters();
                
            } catch (error) {
                console.error('Error loading products from Trello:', error);
                document.getElementById('productsGrid').innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:60px;color:#e53e3e;">Error loading products. Please refresh the page.</div>';
            }
        }

        function getStock(productId) {
            if (!productsLoaded) return null;
            if (inventoryData.hasOwnProperty(productId)) {
                return inventoryData[productId];
            }
            return null;
        }

        function getStockDisplay(productId) {
            const stock = getStock(productId);
            if (stock === null) return { html: '', class: '', canBuy: true };
            if (stock === 0) {
                return { 
                    html: '<div class="stock-badge out-of-stock">Currently Out of Stock</div>', 
                    class: 'out-of-stock',
                    canBuy: false 
                };
            }
            if (stock <= 5) {
                return { 
                    html: `<div class="stock-badge low-stock">ðŸ”¥ Only ${stock} Left - Buy Now!</div>`, 
                    class: 'low-stock',
                    canBuy: true 
                };
            }
            return { html: '<div class="stock-badge in-stock">In Stock</div>', class: '', canBuy: true };
        }


let categories=[];
function updateCategories(){categories=[...new Set(products.map(p=>p.category))].sort();}
let activeFilters={search:'',categories:[],priceMin:null,priceMax:null,sort:'name-asc'};
let currentModalProduct=null;
function isApprovedMember(){const u=JSON.parse(localStorage.getItem('peptideUser')||'{}');return u.approved===true;}
function getCart(){return JSON.parse(localStorage.getItem('peptideCart')||'[]');}
function saveCart(c){localStorage.setItem('peptideCart',JSON.stringify(c));updateCartCount();}
function addToCart(id,size){const p=products.find(x=>x.id===id);if(!p)return;const c=getCart();const i=c.findIndex(x=>x.id===id&&x.size===size);if(i>-1)c[i].quantity+=1;else c.push({id,name:p.name,size,price:p.prices[size],quantity:1});saveCart(c);showToast(`${p.name} (${size}) added to cart`);}
function updateCartCount(){document.getElementById('cartCount').textContent=getCart().reduce((s,i)=>s+i.quantity,0);}
function showToast(m){const t=document.getElementById('toast');document.getElementById('toastMessage').textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000);}
function renderCategoryFilters(){document.getElementById('categoryFilters').innerHTML=categories.map(c=>`<label class="filter-checkbox"><input type="checkbox" value="${c}" onchange="toggleCategory('${c}')"><span>${c}</span></label>`).join('');}
function toggleCategory(c){const i=activeFilters.categories.indexOf(c);if(i>-1)activeFilters.categories.splice(i,1);else activeFilters.categories.push(c);applyFilters();}
function applyFilters(){let f=[...products];if(activeFilters.search){const s=activeFilters.search.toLowerCase();f=f.filter(p=>p.name.toLowerCase().includes(s)||p.description.toLowerCase().includes(s)||p.category.toLowerCase().includes(s));}if(activeFilters.categories.length)f=f.filter(p=>activeFilters.categories.includes(p.category));if(isApprovedMember()){if(activeFilters.priceMin!==null)f=f.filter(p=>Math.min(...Object.values(p.prices))>=activeFilters.priceMin);if(activeFilters.priceMax!==null)f=f.filter(p=>Math.min(...Object.values(p.prices))<=activeFilters.priceMax);}switch(activeFilters.sort){case'name-asc':f.sort((a,b)=>a.name.localeCompare(b.name));break;case'name-desc':f.sort((a,b)=>b.name.localeCompare(a.name));break;case'price-asc':f.sort((a,b)=>Math.min(...Object.values(a.prices))-Math.min(...Object.values(b.prices)));break;case'price-desc':f.sort((a,b)=>Math.min(...Object.values(b.prices))-Math.min(...Object.values(a.prices)));break;}renderProducts(f);renderActiveFilters();document.getElementById('resultsCount').textContent=`${f.length} product${f.length!==1?'s':''}`;document.getElementById('emptyState').classList.toggle('hidden',f.length>0);document.getElementById('productsGrid').classList.toggle('hidden',f.length===0);}
function renderActiveFilters(){const t=[];if(activeFilters.search)t.push(`<span class="filter-tag">Search: "${activeFilters.search}" <button onclick="clearSearch()"><svg viewBox="0 0 24 24" fill="none" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></span>`);activeFilters.categories.forEach(c=>t.push(`<span class="filter-tag">${c} <button onclick="removeCategory('${c}')"><svg viewBox="0 0 24 24" fill="none" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></span>`));document.getElementById('activeFilters').innerHTML=t.join('');}
function clearSearch(){activeFilters.search='';document.getElementById('searchInput').value='';document.getElementById('headerSearchInput').value='';applyFilters();}
function removeCategory(c){activeFilters.categories=activeFilters.categories.filter(x=>x!==c);const cb=document.querySelector(`#categoryFilters input[value="${c}"]`);if(cb)cb.checked=false;applyFilters();}
function resetFilters(){activeFilters={search:'',categories:[],priceMin:null,priceMax:null,sort:'name-asc'};document.getElementById('searchInput').value='';document.getElementById('headerSearchInput').value='';document.getElementById('priceMin').value='';document.getElementById('priceMax').value='';document.getElementById('sortSelect').value='name-asc';document.querySelectorAll('#categoryFilters input').forEach(cb=>cb.checked=false);applyFilters();}
function renderProducts(list){const g=document.getElementById('productsGrid');const m=isApprovedMember();g.innerHTML=list.map(p=>{const min=Math.min(...Object.values(p.prices));const stockInfo=getStockDisplay(p.id);return`<div class="product-card ${stockInfo.class}" onclick="openModal('${p.id}')"><div class="product-image">${p.badge?`<span class="product-badge">${p.badge}</span>`:''}<img src="${p.image}" alt="${p.name}" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';"><div class="product-placeholder" style="display:none;"><svg viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg></div></div><div class="product-info"><div class="product-category">${p.category}</div><h3 class="product-name">${p.name}</h3><div class="product-meta"><span>Purity: ${p.purity}</span><span>${p.form}</span></div>${stockInfo.html}${m?`<div class="product-price">$${min}${p.sizes.length>1?'+':''}</div>`:`<div class="product-price hidden-price">Login for pricing</div>`}<div class="product-sizes">${p.sizes.map(s=>`<span class="size-tag">${s}</span>`).join('')}</div></div></div>`;}).join('');}
function openModal(id){const p=products.find(x=>x.id===id);if(!p)return;currentModalProduct=p;const stockInfo=getStockDisplay(p.id);document.getElementById('modalCategory').textContent=p.category;document.getElementById('modalTitle').textContent=p.name;const modalImg=document.getElementById('modalImage');modalImg.src=p.image;modalImg.alt=p.name;modalImg.style.display='block';modalImg.nextElementSibling.style.display='none';document.getElementById('modalSpecs').innerHTML=`<div class="spec-item"><label>Purity</label><span>${p.purity}</span></div><div class="spec-item"><label>Form</label><span>${p.form}</span></div><div class="spec-item"><label>Formula</label><span>${p.specs.formula}</span></div><div class="spec-item"><label>Mol. Weight</label><span>${p.specs.weight}</span></div>${stockInfo.html?`<div class="spec-item stock-spec">${stockInfo.html}</div>`:''}`;const m=isApprovedMember();const sel=document.getElementById('modalSizeSelect');sel.innerHTML='<option value="">-- Choose a size --</option>'+p.sizes.map(s=>`<option value="${s}">${s}${m?` - $${p.prices[s]}`:''}</option>`).join('');sel.classList.remove('error');sel.disabled=!stockInfo.canBuy;document.getElementById('sizeError').classList.remove('show');const addBtn=document.querySelector('.modal-add-btn');if(addBtn){addBtn.disabled=!stockInfo.canBuy;addBtn.textContent=stockInfo.canBuy?'Add to Cart':'Out of Stock';}document.getElementById('modalDescription').innerHTML=p.description.replace(/\n\n/g,'<br><br>');document.getElementById('productModal').classList.add('active');document.body.style.overflow='hidden';}
function closeModal(){document.getElementById('productModal').classList.remove('active');document.body.style.overflow='';currentModalProduct=null;}
function addModalToCart(){if(!currentModalProduct)return;const sel=document.getElementById('modalSizeSelect');if(!sel.value){sel.classList.add('error');document.getElementById('sizeError').classList.add('show');return;}addToCart(currentModalProduct.id,sel.value);closeModal();}
document.getElementById('searchInput').addEventListener('input',e=>{activeFilters.search=e.target.value;document.getElementById('headerSearchInput').value=e.target.value;applyFilters();});
document.getElementById('headerSearchInput').addEventListener('input',e=>{activeFilters.search=e.target.value;document.getElementById('searchInput').value=e.target.value;applyFilters();});
document.getElementById('sortSelect').addEventListener('change',e=>{activeFilters.sort=e.target.value;applyFilters();});
document.getElementById('priceMin').addEventListener('input',e=>{activeFilters.priceMin=e.target.value?Number(e.target.value):null;applyFilters();});
document.getElementById('priceMax').addEventListener('input',e=>{activeFilters.priceMax=e.target.value?Number(e.target.value):null;applyFilters();});
document.getElementById('productModal').addEventListener('click',e=>{if(e.target.classList.contains('modal-overlay'))closeModal();});
document.getElementById('modalSizeSelect').addEventListener('change',()=>{document.getElementById('modalSizeSelect').classList.remove('error');document.getElementById('sizeError').classList.remove('show');});
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeModal();});
document.addEventListener('DOMContentLoaded',()=>{updateCartCount();loadProductsFromTrello();const cat=new URLSearchParams(window.location.search).get('category');if(cat){activeFilters.categories=[cat];}});
    </script>
</body>
</html>
